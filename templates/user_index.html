{% extends 'master_header.html' %}
{% load static %}

{% block content %}
<!-- Modal div -->
<div class="modal fade" id="id-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
    </div>
  </div>
</div>



<div class="section">
  <h1>User Profile page</h1>
</div>


<div class="section">
  <h1>My details</h1>
  <div class="content container">
    <table class="sortable">
      <tr>
	<th class="th-center">Name</th>
	<th class="th-center">Affiliation</th>    
      </tr>
      <tr>
	<td class="td-center">{{user.username}}</td>
	<td class="td-center">{{user.affiliation}}</td>
      </tr>
    </table>
  </div>
</div>


<div class="section">
  <h1>My Groups</h1>
  <div class="content container">
    <table class="sortable">
      <tr>
	<th class="th-center">Name</th>
	<th class="th-center">Description</th>  
      </tr>
      {% for group in user.getGroupsIsMember %}
      <tr>
	<td class="td-center"><a href="{{ group.get_absolute_url }}">{{group.name}}</td>
	<td class="td-center">{{group.description}}</td>  
      </tr>
      {% endfor %}
    </table>
  </div>
</div>


<div class="section">
  <h1>Pending Tasks ({{ N_tasks }})</h1>
  <div>
    {% if N_tasks > 0 %}
    <table class="tasks sortable">
      <thead>
	<tr>
	  <th>Type</th>
	  <th>Created at</th>
	  <th>From</th>
	  <th>Receivers</th>
	</tr>
      </thead>
      <tbody>
	{% for recipients,task in pending_conf %}
	<tr>
	  <td>{{ task.task_type }}</td>
	  <td>{{ task.created_at }}</td>
	  <td>{{ task.owner }}</td>
	  <td>{{ recipients }}</td>
	</tr>
	{% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No pending confirmation tasks</p>
    {% endif %}
    <a href="{% url 'sled_tasks:tasks-list' %}">All tasks ({{ N_tasks_all }})</a>
  </div>
</div>


<div class="section">
  <h1>New Notifications ({{ unread_notifications|length }})</h1>
  <div>
    {% if unread_notifications %}
    <table class="notifications sortable">
      <thead>
	<tr>
	  <th>Sender</th>
	  <th>Sent at</th>
	  <th>Level</th>
	  <th>Verb</th>
	</tr>
      </thead>
      <tbody>
	{% for note in unread_notifications %}
	<tr>
	  <td>{{ note.actor }}</td>
	  <td>{{ note.timestamp }}</td>
	  <td>{{ note.level }}</td>
	  <td>{{ note.verb }}</td>
	</tr>
	{% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No new notifications</p>
    {% endif %}
    <a href="{% url 'sled_notifications:notifications-list' %}">All notifications({{ N_note_all }})</a>
  </div>
</div>


<div class="section">
  <h1>My Collections ({{ collections|length }}) </h1>
  <div class="content ">
    {% if collections %}
    <table class="collections">
      <thead>
	<tr>
	  <th>Name</th>
	  <th>Type</th>
	  <th>Description</th>
	  <th>N. of items</th>
	</tr>
      </thead>
      <tbody>
	{% for collection in collections %}
	<tr>
	  <td><a href="{{ collection.get_absolute_url }}">{{ collection.name }}</a></td>
	  <td>{{ collection.item_type }}</td>
	  <td>{{ collection.description }}</td>
	  <td>{{ collection.myitems.all|length }}</td>
	</tr>
	{% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No collections to display</p>
    {% endif %}
    <a href="{% url 'sled_collections:collections-list' %}">All collections</a>
  </div>
</div>


<div class="section">
  <h1>My Lenses ({{ lenses|length }}) </h1>
  <div class="content ">
    <form id="ids-form" method="POST">
      {% csrf_token %}
      {% include "lenses/lens_list_executive.html" with lenses=lenses %}
    </form>
  </div>
</div>


<div class="controls">

  <!-- Neutral buttons - they don't change the database -->
  <button type="submit" class="update btn btn-sm btn-secondary" form="ids-form" formaction="{% url 'lenses:lens-update' %}">
    <img src="{% static 'icons/pencil.svg' %}" alt="pencil">
    Update lenses
  </button>
  <button type="button" class="process-lenses make-collection btn btn-sm btn-secondary" data-form-url="{% url 'lenses:lens-make-collection' %}">
    <img src="{% static 'icons/folder-fill.svg' %}" alt="collection">
    Make collection
  </button>
  <button type="submit" class="collage btn btn-sm btn-secondary" form="ids-form" formaction="{% url 'lenses:lens-collage' %}">
    <img src="{% static 'icons/images.svg' %}" alt="image collage">
    Collage
  </button>

  <!-- Action buttons - performing some action without any danger of exposing sensitive information -->
  <button type="button" class="process-lenses make-private btn btn-sm btn-primary" data-form-url="{% url 'lenses:lens-make-private' %}">
    <img src="{% static 'icons/lock-fill.svg' %}" alt="lock">
    Make private
  </button>
  <button type="button" class="process-lenses revoke-access btn btn-sm btn-primary" data-form-url="{% url 'lenses:lens-revoke-access' %}">
    <img src="{% static 'icons/person-dash-fill.svg' %}" alt="person minus">
    Revoke access
  </button>

  <!-- Dangerous action buttons - revealing sensitive information if not used properly -->
  <button type="button" class="process-lenses give-access btn btn-sm btn-danger" data-form-url="{% url 'lenses:lens-give-access' %}">
    <img src="{% static 'icons/person-plus-fill.svg' %}" alt="person plus">
    Give access
  </button>
  <button type="button" class="process-lenses make-public btn btn-sm btn-danger" data-form-url="{% url 'lenses:lens-make-public' %}">
    <img src="{% static 'icons/people-fill.svg' %}" alt="people">
    Make public
  </button>
  <button type="button" class="process-lenses cede-ownership btn btn-sm btn-danger" data-form-url="{% url 'lenses:lens-cede-ownership' %}">
    <img src="{% static 'icons/forward-fill.svg' %}" alt="arrow">
    Cede ownership
  </button>
  <button type="button" class="process-lenses delete-lenses btn btn-sm btn-danger" data-form-url="{% url 'lenses:lens-delete' %}">
    <img src="{% static 'icons/trash.svg' %}" alt="trash">
    Delete lenses
  </button>
</div>
{% endblock content %}


{% block extrastyles %}
<!-- <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}"> -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
  .notifications td {margin:0px;padding:2px;}
  .tasks td {margin:0px;padding:2px;}
  .collections td {margin:0px;padding:2px;}
  .exe_summary td {margin:0px;padding:2px;}
</style>
{% endblock extrastyles %}


{% block extrascripts %}
<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2" crossorigin="anonymous"></script>
<!-- <script src="{% static 'js/jquery-3.2.1.min.js' %}"></script> -->
<!-- <script src="{% static 'js/bootstrap.min.js' %}"></script> -->
<script src="{% static 'js/jquery.bootstrap.modal.forms.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script type="text/javascript" src="{% static 'lenses/js/autocomplete.js' %}"></script>
<script type="text/javascript">
  $(document).ready(function() {
      $(".process-lenses").click(function (){

	  // Construct get query string
	  var values = [];
	  $('.content input[type="checkbox"]:checked').each(function (){
	      values.push( 'ids='+$(this).val() );
	  });

	  if( values.length == 0){
              alert('You need to select at least one item!');
	  } else {
	      var get_str = '?'+values.join('&')+'&';
	      
	      // Fetch only the first part of the URL (without any GET arguments)
	      var url = $(this).data('form-url').split('?');
	      var url_core = url[0];

	      // Trigger modal
	      var new_form_url = url_core+get_str;
              $(this).modalFormTrigger({
		  formURL: new_form_url,
 		  modalID: "#id-modal"
	      });
	  }
	  
      });

      $(".alert").fadeTo(3000,1000).slideUp(1000, function () {
          $(".alert").slideUp(1000);
      });
  });
</script>
{% endblock extrascripts %}

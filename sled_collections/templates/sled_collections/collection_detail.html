{% extends 'master_header.html' %}
{% load static %}


{% block content %}

<!-- Modal divs -->
<div class="modal fade" tabindex="-1" role="dialog" id="id-modal-large">
  <div class="modal-dialog modal-xl">
    <div class="modal-content"></div>
  </div>
</div>
<div class="modal fade" tabindex="-1" role="dialog" id="id-modal">
  <div class="modal-dialog">
    <div class="modal-content"></div>
  </div>
</div>
<div class="modal fade" tabindex="-1" role="dialog" id="id-modal-remove-items">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
	<h5 class="modal-title">Remove the following items?</h5>
	<button type="button" class="close" data-dismiss="modal" aria-label="Close">
	  <span aria-hidden="true">&times;</span>
	</button>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
	<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	<button type="submit" form="ids-form" formaction="{% url 'sled_collections:collections-detail' collection.pk %}" class="btn btn-primary">Confirm</button>
      </div>
    </div>
  </div>
</div>


<h1>{{ collection.name }}</h1>

<hr>

<!-- Div with some information about the collection and different actions for users or the owner -->
<div>
  <p>Item type: {{ collection.item_type }}</p>
  <p>Description: {{ collection.description }}</p>
  <p>Access level: {{ collection.access_level }}</p>

  {% if collection.owner == user %}
  <button type="button" id="update-collection" class="btn btn-sm btn-primary" data-form-url="{% url 'sled_collections:collection-update' collection.pk %}">
    <img src="{% static 'icons/pencil.svg' %}" alt="pencil">
    Update
  </button>
  <button type="button" id="delete-collection" class="btn btn-sm btn-danger" data-form-url="{% url 'sled_collections:collection-delete' collection.pk %}">
    <img src="{% static 'icons/trash.svg' %}" alt="trash">
    Delete
  </button>
  
  <button type="button" id="revoke-access" class="jb-submit-button-1" data-form-url="{% url 'sled_collections:collection-revoke-access' collection.pk %}">
    <img src="{% static 'icons/person-dash-fill.svg' %}" alt="person minus">
    Revoke access
  </button>
  <button type="button" id="give-access" class="jb-submit-button-1" data-form-url="{% url 'sled_collections:collection-give-access' collection.pk %}">
    <img src="{% static 'icons/person-plus-fill.svg' %}" alt="person plus">
    Give access
  </button>
  
  Some notes here:
  <ul>
    <li>Button: If private make public (no need to make a public collection private, just delete it)</li>
  </ul>
  {% endif %}
</div>

<hr>

{% if collection.owner == user %}
<div>
  <h3>Access to the collection:</h3>
  <p>Users:</p>
  {{ collection.getUsersWithAccessNoOwner|join:"," }}
  <p>Groups:</p>
  {{ collection.getGroupsWithAccessNoOwner|join:"," }}
</div>
{% else %}
<div>
  <h3>Access to the collection:</h3>
  <p>
    You can access <strong>{{ accessible_items|length }}</strong> out of <strong>{{ collection.myitems.all|length }}</strong> items in the collection.
  </p>
  <button type="button" id="ask-access" class="jb-submit-button-1" data-form-url="{% url 'sled_collections:collection-ask-access' collection.pk %}">
    <img src="{% static 'icons/person-plus-fill.svg' %}" alt="person plus">
    Ask access
  </button>
</div>
{% endif %}

<!-- List of items in the collection -->
<div>
  <h3>Items in the collection:</h3>
  <form id="ids-form" method="POST">
    {% csrf_token %}
    <input type="hidden" name="collection_id" id="collection_id" value="{{ collection.id }}">
    <span class="errorlist">{{ error_message }}</span>
    {% if collection.item_type == 'Lenses' %}
    {% include "lenses/lens_list_passive.html" with lenses=accessible_items  %}
    {% else %}
    <p> Unknown item type </p>
    {% endif %}
  </form>
</div>

<hr>

<!-- Actions for the group owner -->
{% if  collection.owner == user %}
<div>
  <form id="add-items-form" action="{% url 'lenses:lens-query' %}">
    <button type="submit" form="add-items-form" class="btn btn-sm btn-primary" >
      <img src="{% static 'icons/plus.svg' %}" alt="plus">
      Add items
    </button>
  </form>
  <button type="button" id="remove-items" class="btn btn-sm btn-danger" data-toggle="modal" data-target="#id-modal-remove-items">
    <img src="{% static 'icons/trash.svg' %}" alt="trash">
    Remove selected
  </button>
</div>
{% endif %}

<hr>
{% endblock content %}


{% block extrastyles %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock extrastyles %}


{% block extrascripts %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2" crossorigin="anonymous"></script>
<script src="{% static 'js/jquery.bootstrap.modal.forms.js' %}"></script>
<script type="text/javascript" src="{% static 'lenses/js/autocomplete.js' %}"></script>
<script type="text/javascript">
  $(document).ready(function() {
      $("#delete-collection").modalForm({
	  formURL: $("#delete-collection").data("form-url"),
	  modalID: "#id-modal",
	  isDeleteForm: true
      });

      $("#update-collection").modalForm({
          formURL: $("#update-collection").data("form-url"),
 	  modalID: "#id-modal"
      });

      $("#give-access").modalForm({
          formURL: $("#give-access").data("form-url"),
 	  modalID: "#id-modal"
      });

      $("#revoke-access").modalForm({
          formURL: $("#revoke-access").data("form-url"),
 	  modalID: "#id-modal"
      });
      
      $("#ask-access").modalForm({
          formURL: $("#ask-access").data("form-url"),
 	  modalID: "#id-modal"
      });

      $("#remove-items").click(function (e) {
	  var names = [];
          $("input[name='ids']:checked").each(function(){
	      name = $(this).parent().parent().find('a').text();
	      names.push('<li>'+name+'</li>');
	  });
	  if( names.length == 0 ){
              $("#id-modal-remove-items").find('.modal-body').html('You need to select at least one item!');
	  } else {
	      str = '<ul>' + names.join('') + '</ul>';
              $("#id-modal-remove-items").find('.modal-body').html(str);
	  }
      });
	  
      $('#toggle_all').remove();
      
  });
</script>
{% endblock extrascripts %}
